name: APK Compressor (LZMA2 Ultra)

on:
  workflow_dispatch:
    inputs:
      apk_url:
        description: 'Direct Download URL for the APK'
        required: true
        type: string

jobs:
  compress:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Setup Environment
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2. Install 7-Zip (Modern)
      - name: Install 7-Zip
        run: |
          sudo apt-get update
          sudo apt-get install -y 7zip || sudo apt-get install -y p7zip-full

      # 3. Download APK
      - name: Download APK
        run: |
          echo "Downloading from: ${{ inputs.apk_url }}"
          wget -O input_app.apk "${{ inputs.apk_url }}"
          
          # Capture Original Size
          echo "ORIGINAL_SIZE=$(stat -c%s input_app.apk)" >> $GITHUB_ENV

      # 4. Compress using LZMA2 (The standard for Binary/Mixed files)
      - name: Compress to .7z (LZMA2 Extreme)
        run: |
          # Settings Explanation:
          # -m0=lzma2  : The best algorithm for pre-compressed binaries (like APKs).
          # -mx=9      : Ultra compression level.
          # -md=512m   : Dictionary size 512MB. (Requires ~5-6GB RAM to compress, safe for GitHub runners).
          # -mfb=273   : Maximum "Fast Bytes" (scans harder for matches).
          # -ms=on     : Solid compression (crucial for size).
          
          CMD="7z"
          if command -v 7zz &> /dev/null; then CMD="7zz"; fi
          
          $CMD a -t7z compressed_app.7z input_app.apk -m0=lzma2 -mx=9 -md=512m -mfb=273 -ms=on
          
          # Capture Final Size
          echo "COMPRESSED_SIZE=$(stat -c%s compressed_app.7z)" >> $GITHUB_ENV

      # 5. Calculate Reduction
      - name: Compression Report
        run: |
          orig=${{ env.ORIGINAL_SIZE }}
          comp=${{ env.COMPRESSED_SIZE }}
          # Use basic bash math for ratio
          ratio=$(( 100 * comp / orig ))
          saved=$(( 100 - ratio ))
          
          echo "=== RESULT ==="
          echo "Original:   $((orig / 1024 / 1024)) MB"
          echo "Compressed: $((comp / 1024 / 1024)) MB"
          echo "Size is $ratio% of original (Saved $saved%)"

      # 6. Upload Result
      - name: Upload Result
        uses: actions/upload-artifact@v4
        with:
          name: Compressed-APK-LZMA2
          path: compressed_app.7z
          retention-days: 3
